name: Build and Deploy to Orange Pi

on:
  push:
    branches:
      - "main"
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    concurrency:
      group: "deployment"
      cancel-in-progress: false
    
    steps:
      - name: Check out repository code
        uses: actions/checkout@v3
      
      # Настройка Node.js с правильным кэшированием для монорепозитория
      - name: Setup Node.js for Frontend
        uses: actions/setup-node@v3
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: 'frontend/package-lock.json'
      
      # Сборка фронтенда
      - name: Build Frontend
        run: |
          cd frontend
          npm ci
          npm run build
      
      # Настройка Node.js для бэкенда
      - name: Setup Node.js for Backend
        uses: actions/setup-node@v3
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: 'backend/package-lock.json'
      
      # Сборка бэкенда - только установка зависимостей
      - name: Prepare Backend
        run: |
          cd backend
          npm ci --omit=dev
      
      # Создаем директорию для деплоя
      - name: Prepare deployment directory
        run: |
          mkdir -p deploy
          cp -r backend/* deploy/
          mkdir -p deploy/frontend/dist
          cp -r frontend/dist/* deploy/frontend/dist/
      
      # Собираем Docker образ
      - name: Build Docker image
        run: |
          cat > Dockerfile.deploy << 'EOF'
          FROM node:20-alpine
          WORKDIR /app
          COPY . /app/
          EXPOSE 3000
          ENV NODE_ENV=production
          ENV EXTERNAL_FHIR_URL='https://server.fire.ly/r4'
          CMD ["node", "server.js"]
          EOF
          
          docker build -t fhir-app:latest -f Dockerfile.deploy deploy
          
          # Сохраняем образ в файл
          docker save fhir-app:latest > fhir-app-image.tar
      
      # Настройка SSH для подключения к Orange Pi
      - name: Set up SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
          ssh-keyscan -p ${{ secrets.ORANGE_PI_PORT }} -H ${{ secrets.ORANGE_PI_IP }} >> ~/.ssh/known_hosts
      
      # Отправка Docker образа на сервер
      - name: Upload Docker image
        run: |
          echo "Uploading Docker image to server (this may take some time)..."
          scp -i ~/.ssh/id_ed25519 -P ${{ secrets.ORANGE_PI_PORT }} \
            fhir-app-image.tar \
            ${{ secrets.ORANGE_PI_USER }}@${{ secrets.ORANGE_PI_IP }}:/tmp/fhir-app-image.tar
          echo "Upload completed."
      
      # Деплой Docker контейнера на сервере
      - name: Deploy Docker container
        run: |
          ssh -i ~/.ssh/id_ed25519 -p ${{ secrets.ORANGE_PI_PORT }} \
            ${{ secrets.ORANGE_PI_USER }}@${{ secrets.ORANGE_PI_IP }} << 'EOF'
            set -e
            set -x
            
            echo "Loading Docker image from file..."
            docker load < /tmp/fhir-app-image.tar
            
            echo "Stopping and removing old container if exists..."
            docker stop fhir_app || true
            docker rm fhir_app || true
            
            echo "Starting new container..."
            docker run -d --name fhir_app \
              -p 80:3000 \
              -e NODE_ENV=production \
              -e EXTERNAL_FHIR_URL='https://server.fire.ly/r4' \
              --restart unless-stopped \
              fhir-app:latest
            
            echo "Cleaning up..."
            rm -f /tmp/fhir-app-image.tar
            
            echo "Container status:"
            docker ps | grep fhir
            
            echo "Container logs:"
            docker logs fhir_app --tail 20
          EOF
      
      # Проверка доступности приложения
      - name: Check application availability
        run: |
          ssh -i ~/.ssh/id_ed25519 -p ${{ secrets.ORANGE_PI_PORT }} \
            ${{ secrets.ORANGE_PI_USER }}@${{ secrets.ORANGE_PI_IP }} << 'EOF'
            # Проверка, что приложение слушает порт 80
            if netstat -tuln | grep -q ":80 "; then
              echo "Application is listening on port 80"
            else
              echo "Warning: Application does not seem to be listening on port 80"
              docker logs fhir_app --tail 100
            fi
            
            # Проверка, что приложение отвечает на HTTP запросы (с таймаутом)
            timeout 10 curl -s http://localhost:80/ > /dev/null || echo "Warning: Application does not respond to HTTP requests"
          EOF
